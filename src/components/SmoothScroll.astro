---
// SmoothScroll — Lenis smooth scroll + GSAP ScrollTrigger ticker sync
// This component initializes the smooth scroll engine and all page animations.
---

<script>
  import Lenis from 'lenis';
  import { gsap } from 'gsap';
  import { ScrollTrigger } from 'gsap/ScrollTrigger';

  gsap.registerPlugin(ScrollTrigger);

  const prefersReducedMotion = window.matchMedia('(prefers-reduced-motion: reduce)').matches;

  // Initialize Lenis smooth scroll
  const lenis = new Lenis({
    duration: 1.2,
    easing: (t: number) => Math.min(1, 1.001 - Math.pow(2, -10 * t)),
    smoothWheel: !prefersReducedMotion,
  });

  lenis.on('scroll', ScrollTrigger.update);

  gsap.ticker.add((time: number) => {
    lenis.raf(time * 1000);
  });
  gsap.ticker.lagSmoothing(0);

  // ─── Nav scroll shadow ───────────────────────────────────────────
  const nav = document.getElementById('site-nav');
  if (nav) {
    ScrollTrigger.create({
      start: 'top -100',
      onUpdate: (self) => {
        if (self.direction === 1 && self.scroll() > 100) {
          nav.classList.add('nav--scrolled');
        } else if (self.scroll() <= 100) {
          nav.classList.remove('nav--scrolled');
        }
      },
    });
  }

  // ─── Hero entrance ───────────────────────────────────────────────
  if (!prefersReducedMotion) {
    const heroTimeline = gsap.timeline({ defaults: { ease: 'power2.out' } });
    const mascot = document.querySelector('[data-hero-mascot]');

    if (mascot) {
      gsap.set(mascot, { scale: 0.98, opacity: 0 });
      gsap.set(nav, { y: -8, opacity: 0 });

      heroTimeline
        .to(nav, { y: 0, opacity: 1, duration: 0.25 }, 0)
        .to(mascot, { scale: 1, opacity: 1, duration: 0.3 }, 0.05);
    }
  }

  // ─── Tagline fade-in ─────────────────────────────────────────────
  const tagline = document.querySelector('[data-tagline]') as HTMLElement;
  if (tagline && !prefersReducedMotion) {
    gsap.set(tagline, { opacity: 0, y: 8 });

    gsap.to(tagline, {
      opacity: 1,
      y: 0,
      duration: 0.3,
      ease: 'power2.out',
      scrollTrigger: {
        trigger: tagline,
        start: 'top 90%',
        toggleActions: 'play none none none',
      },
    });
  }

  // ─── Manifesto scroll reveal ─────────────────────────────────────
  const manifestoText = document.querySelector('[data-manifesto-text]') as HTMLElement;
  if (manifestoText && !prefersReducedMotion) {
    gsap.set(manifestoText, { opacity: 0, y: 10 });

    gsap.to(manifestoText, {
      opacity: 1,
      y: 0,
      duration: 0.3,
      ease: 'power2.out',
      scrollTrigger: {
        trigger: manifestoText,
        start: 'top 85%',
        toggleActions: 'play none none none',
      },
    });
  }

  // ─── About fade-in ───────────────────────────────────────────────
  const about = document.querySelector('[data-about]') as HTMLElement;
  if (about && !prefersReducedMotion) {
    const aboutContent = about.querySelector('.about__content');
    if (aboutContent) {
      gsap.set(aboutContent, { opacity: 0, y: 12 });

      gsap.to(aboutContent, {
        opacity: 1,
        y: 0,
        duration: 0.3,
        ease: 'power2.out',
        scrollTrigger: {
          trigger: about,
          start: 'top 80%',
          toggleActions: 'play none none none',
        },
      });
    }
  }

  // ─── Services staggered fade-up ──────────────────────────────────
  const servicesItems = document.querySelectorAll('[data-services-item]');
  if (servicesItems.length && !prefersReducedMotion) {
    gsap.set(servicesItems, { y: 12, opacity: 0 });

    gsap.to(servicesItems, {
      y: 0,
      opacity: 1,
      duration: 0.25,
      stagger: 0.04,
      ease: 'power2.out',
      scrollTrigger: {
        trigger: '[data-services]',
        start: 'top 80%',
        toggleActions: 'play none none none',
      },
    });
  }

  // ─── Journal staggered fade-up ───────────────────────────────────
  const journalItems = document.querySelectorAll('[data-journal-item]');
  if (journalItems.length && !prefersReducedMotion) {
    gsap.set(journalItems, { y: 12, opacity: 0 });

    gsap.to(journalItems, {
      y: 0,
      opacity: 1,
      duration: 0.25,
      stagger: 0.04,
      ease: 'power2.out',
      scrollTrigger: {
        trigger: '[data-journal]',
        start: 'top 80%',
        toggleActions: 'play none none none',
      },
    });
  }

  // ─── Values staggered fade-up ────────────────────────────────────
  const valuesItems = document.querySelectorAll('[data-values-item]');
  if (valuesItems.length && !prefersReducedMotion) {
    gsap.set(valuesItems, { y: 12, opacity: 0 });

    gsap.to(valuesItems, {
      y: 0,
      opacity: 1,
      duration: 0.25,
      stagger: 0.06,
      ease: 'power2.out',
      scrollTrigger: {
        trigger: '[data-values]',
        start: 'top 80%',
        toggleActions: 'play none none none',
      },
    });
  }

  // ─── Contact fade-in ─────────────────────────────────────────────
  const contact = document.querySelector('[data-contact]') as HTMLElement;
  if (contact && !prefersReducedMotion) {
    const contactHeading = contact.querySelector('h2');
    const contactEmail = contact.querySelector('a');
    const contactLabel = contact.querySelector('p');

    if (contactHeading) {
      gsap.set([contactLabel, contactHeading, contactEmail], { opacity: 0, y: 10 });

      gsap.to([contactLabel, contactHeading, contactEmail], {
        opacity: 1,
        y: 0,
        duration: 0.3,
        stagger: 0.06,
        ease: 'power2.out',
        scrollTrigger: {
          trigger: contact,
          start: 'top 80%',
          toggleActions: 'play none none none',
        },
      });
    }
  }
</script>
